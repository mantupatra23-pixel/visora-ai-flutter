name: ☁️ Visora AI Cloud v3 – Auto-Healing Build & Release APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 🧠 Checkout Repository
        uses: actions/checkout@v4

      - name: 🧰 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"  # ✅ Updated to latest stable (Fix for SDK mismatch)

      - name: 🔧 Auto-Heal Gradle Config
        run: |
          echo "⚙️ Applying Gradle Auto-Heal Fix..."
          cat > android/build.gradle <<'EOF'
          buildscript {
              ext.kotlin_version = '1.9.25'
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.5.2'
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
                  classpath 'com.google.gms:google-services:4.4.2'
              }
          }

          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }

          rootProject.buildDir = "../build"

          // ✅ EARLY EVALUATION FIX
          gradle.beforeProject { project ->
              if (project.hasProperty("android")) {
                  project.android {
                      if (!project.hasProperty("compileSdkVersion")) compileSdkVersion 35
                      if (!project.hasProperty("namespace")) namespace = "com.example.visora_ai_flutter"
                  }
              }
          }

          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
              project.evaluationDependsOn(":app")

              tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                  kotlinOptions {
                      jvmTarget = "17"
                      apiVersion = "1.9"
                      languageVersion = "1.9"
                      freeCompilerArgs += ["-Xskip-metadata-version-check"]
                  }
              }
          }

          tasks.register("clean", Delete) {
              delete rootProject.buildDir
          }
          EOF
          echo "✅ Gradle Auto-Heal Complete!"

      - name: 📦 Flutter Pub Get
        run: flutter pub get

      - name: 🔑 Setup Google Services
        run: echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > android/app/google-services.json

      - name: 🚀 Build Release APK
        run: |
          echo "🏗️ Building Visora AI Release APK..."
          flutter build apk --release
          echo "✅ Build Completed Successfully!"

      - name: ☁️ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Visora-AI-Cloud-Build
          path: build/app/outputs/flutter-apk/app-release.apk
