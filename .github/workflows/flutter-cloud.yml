name: â˜ï¸ Visora AI Cloud V3 â€” Auto-Healing Flutter Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1 â€” Checkout Repo
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # âœ… Step 2 â€” Setup Flutter
      - name: ğŸ§  Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"

      # âœ… Step 3 â€” Auto-Heal Gradle & SDK
      - name: ğŸ©º Auto-Heal Gradle Config
        run: |
          echo "ğŸ©¹ Healing Gradle & SDK Configurations..."
          cat > android/build.gradle <<'EOF'
          buildscript {
              ext.kotlin_version = '1.9.25'
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.5.2'
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.25"
                  classpath 'com.google.gms:google-services:4.4.2'
              }
          }

          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }

          rootProject.buildDir = '../build'
          gradle.beforeProject { project ->
              if (project.hasProperty("android")) {
                  project.android {
                      if (!project.hasProperty("compileSdkVersion")) {
                          compileSdkVersion 35
                      }
                      if (!project.hasProperty("namespace")) {
                          namespace = "com.example.visora_ai_flutter"
                      }
                  }
              }
          }

          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
              project.evaluationDependsOn(':app')
              tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile) {
                  kotlinOptions {
                      jvmTarget = '17'
                      apiVersion = '1.9'
                      languageVersion = '1.9'
                      freeCompilerArgs = ['-Xskip-metadata-version-check']
                  }
              }
          }

          tasks.register("clean", Delete) {
              delete rootProject.buildDir
          }
          EOF

          echo "ğŸ§¾ Setting Android SDK Versions..."
          echo -e "\nflutter.minSdkVersion=23\nflutter.targetSdkVersion=35\nflutter.compileSdkVersion=35" >> android/gradle.properties

          echo "âš™ï¸ Creating MainActivity.kt (V2 Embedding)..."
          mkdir -p android/app/src/main/kotlin/com/example/visora_ai_flutter
          cat > android/app/src/main/kotlin/com/example/visora_ai_flutter/MainActivity.kt <<EOL
          package com.example.visora_ai_flutter

          import io.flutter.embedding.android.FlutterActivity

          class MainActivity: FlutterActivity() {
          }
          EOL

          echo "ğŸ§¹ Cleaning old Manifest activities..."
          sed -i '/<activity/,/<\/activity>/d' android/app/src/main/AndroidManifest.xml

          echo "âœ… Auto-Heal complete!"

      # âœ… Step 4 â€” Flutter Pub Get
      - name: ğŸ“¦ Flutter Pub Get
        run: flutter pub get

      # âœ… Step 5 â€” Setup Google Services JSON (Firebase)
        # (only if youâ€™re using Firebase; can skip otherwise)
      - name: ğŸ”‘ Setup Google Services
        run: echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > android/app/google-services.json

      # âœ… Step 6 â€” Build Release APK
      - name: ğŸš€ Build Release APK
        run: |
          echo "ğŸš€ Building Visora AI Cloud Release APK..."
          flutter build apk --release
          echo "âœ… Build Completed Successfully!"

      # âœ… Step 7 â€” Upload Artifact to GitHub
      - name: â˜ï¸ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisoraAI-Cloud-Release
          path: build/app/outputs/flutter-apk/app-release.apk
