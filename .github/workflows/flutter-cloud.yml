name: "ğŸš€ Visora AI Cloud â€“ Final Stable V8.4 (Full Auto Build + Dart Sync + Cache Fix)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Flutter
      - name: ğŸ§  Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"

      # 3ï¸âƒ£ Full Dependency Sync & Cleanup
      - name: ğŸ§© Full Flutter Sync (Final Cloud Safe)
        run: |
          echo "ğŸ§¹ Cleaning cache and syncing dependencies..."
          rm -rf .dart_tool build pubspec.lock
          flutter clean
          flutter pub cache repair
          flutter pub get
          flutter pub upgrade --major-versions
          flutter pub run build_runner build --delete-conflicting-outputs || true
          flutter doctor -v
          echo "âœ… Dependencies fully synced!"

      # 4ï¸âƒ£ Firebase Config (Optional)
      - name: ğŸ”¥ Firebase Config
        run: |
          echo "ğŸ”¥ Generating Firebase config..."
          echo '{
            "project_info": {
              "project_number": "${{ secrets.FIREBASE_PROJECT_NUMBER }}",
              "project_id": "${{ secrets.FIREBASE_PROJECT_ID }}",
              "storage_bucket": "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
            },
            "client": [{
              "mobilesdk_app_id": "${{ secrets.FIREBASE_APP_ID }}",
              "client_info": { "package_name": "com.example.visora_ai_flutter" },
              "api_key": [{ "current_key": "${{ secrets.FIREBASE_API_KEY }}" }]
            }],
            "configuration_version": "1"
          }' > android/app/google-services.json
          echo "âœ… Firebase config created."

      # 5ï¸âƒ£ Build APK
      - name: âš™ï¸ Build APK (Final Release)
        run: |
          echo "ğŸš€ Starting release build..."
          flutter build apk --release --no-tree-shake-icons
          echo "âœ… APK build completed successfully!"

      # 6ï¸âƒ£ Upload Artifact
      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisoraAI-Cloud-Release
          path: build/app/outputs/flutter-apk/app-release.apk

      # 7ï¸âƒ£ Optional: Publish to GitHub Release
      - name: ğŸš€ Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/heads/main')
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          tag_name: v${{ github.run_number }}
          name: "Visora AI Cloud Build #${{ github.run_number }}"
          body: |
            âœ… Visora AI Cloud Build Successful!
            ğŸ§  Gradle 8.x + Kotlin 1.9.25
            ğŸ”¥ Firebase Ready
            â˜ï¸ Full Cloud Safe Build
            ğŸ“¦ Auto Artifact + GitHub Release
