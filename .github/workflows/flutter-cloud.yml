name: "Visora AI Cloud V8.3.1 â€“ Final Stable (Full Auto + Cloud Backup)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¾ Step 1 - Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ§  Step 2 - Setup Flutter SDK
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: "stable"

      # ğŸ§© Step 3 - Ensure .dart_tool exists (Fix pubspec issue)
      - name: Ensure Dart Tool Exists
        run: |
          mkdir -p .dart_tool
          flutter pub get || true
          echo "âœ… .dart_tool and dependencies initialized."

      # âš™ï¸ Step 4 - Patch Gradle (Cloud Safe)
      - name: Patch Gradle File
        run: |
          echo "ğŸ§± Patching build.gradle..."
          if ! grep -q "flutter_tools/gradle/flutter.gradle" android/app/build.gradle; then
            echo "def localFlutterGradle = file(\"../packages/flutter_tools/gradle/flutter.gradle\")" >> android/app/build.gradle
            echo "if (localFlutterGradle.exists()) {" >> android/app/build.gradle
            echo "  apply from: localFlutterGradle" >> android/app/build.gradle
            echo "} else {" >> android/app/build.gradle
            echo "  apply from: System.getenv('FLUTTER_ROOT') + '/packages/flutter_tools/gradle/flutter.gradle'" >> android/app/build.gradle
            echo "}" >> android/app/build.gradle
          fi
          echo "âœ… build.gradle patched successfully."

      # ğŸ“¦ Step 5 - Install Dependencies
      - name: Install Dependencies
        run: |
          flutter pub cache repair
          flutter clean
          flutter pub get
          flutter doctor -v
          echo "âœ… Dependencies installed and cache fixed."

      # ğŸ¨ Step 6 - Create Android Resources (Auto)
      - name: Create Android Resources
        run: |
          mkdir -p android/app/src/main/res/mipmap-anydpi-v26
          mkdir -p android/app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
            <background android:drawable="@color/ic_launcher_background"/>
            <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
          </adaptive-icon>' > android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
          echo '<?xml version="1.0" encoding="utf-8"?>
          <resources>
            <color name="ic_launcher_background">#1976D2</color>
            <color name="white">#FFFFFF</color>
            <color name="black">#000000</color>
          </resources>' > android/app/src/main/res/values/colors.xml
          echo '<?xml version="1.0" encoding="utf-8"?>
          <resources>
            <style name="LaunchTheme" parent="android:Theme.Material.Light.NoActionBar">
              <item name="android:windowBackground">@color/white</item>
            </style>
          </resources>' > android/app/src/main/res/values/styles.xml
          echo "âœ… Android icons & themes created."

      # ğŸ”¥ Step 7 - Firebase Config
      - name: Firebase Config
        run: |
          echo '{
            "project_info": {
              "project_number": "${{ secrets.FIREBASE_PROJECT_NUMBER }}",
              "project_id": "${{ secrets.FIREBASE_PROJECT_ID }}",
              "storage_bucket": "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "${{ secrets.FIREBASE_APP_ID }}",
                "android_client_info": {"package_name": "com.example.visora"}
              },
              "api_key": [{"current_key": "${{ secrets.FIREBASE_API_KEY }}"}]
            }],
            "configuration_version": "1"
          }' > android/app/google-services.json
          echo "âœ… Firebase Config added."

      # âš™ï¸ Step 8 - Build APK (Safe Retry)
      - name: Build APK
        run: |
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons || (flutter clean && flutter pub get && flutter build apk --release)
          echo "âœ… Build completed successfully!"

      # ğŸ“¤ Step 9 - Upload Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisoraAI-Cloud-Release
          path: build/app/outputs/flutter-apk/app-release.apk

      # â˜ï¸ Step 10 - Optional Cloud Backup (Google Drive)
      - name: Upload to Cloud Backup (Google Drive)
        if: ${{ secrets.RCLONE_CONF != '' }}
        run: |
          sudo apt-get install -y rclone
          echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf
          rclone copy build/app/outputs/flutter-apk/app-release.apk "mydrive:/VisoraAI/CloudBuilds/"
          echo "â˜ï¸ APK backed up to Google Drive successfully!"

      # ğŸš€ Step 11 - Publish to GitHub Releases
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/heads/main')
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          tag_name: v${{ github.run_number }}
          name: "Visora AI Cloud Build #${{ github.run_number }}"
          body: |
            âœ… Visora AI Cloud Build Successful!
            ğŸ”¹ Gradle 8.x + Kotlin 1.9.25
            ğŸ”¹ Pub Cache Fixed
            ğŸ”¹ Firebase Ready
            ğŸ”¹ Auto Icons + Themes
            ğŸ”¹ Full Cloud Compatible
