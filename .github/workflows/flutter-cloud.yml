name: "ğŸš€ Visora AI Cloud V8.3.7 â€“ Final Stable (Self-Healing Cloud Build)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  FIREBASE_PROJECT_NUMBER: ${{ secrets.FIREBASE_PROJECT_NUMBER }}
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
  FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
  FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
  RCLONE_CONF: ${{ secrets.RCLONE_CONF }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout Repository
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Flutter SDK
      - name: ğŸ§  Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: "stable"

      # 3ï¸âƒ£ Prepare Environment
      - name: ğŸ§° Prepare Environment
        run: |
          mkdir -p .dart_tool
          flutter pub get || true
          echo "âœ… Flutter environment prepared."

      # 4ï¸âƒ£ Patch Gradle File
      - name: ğŸ› ï¸ Patch Gradle File
        run: |
          echo "ğŸ”§ Patching Gradle..."
          sed -i '/apply from/d' android/app/build.gradle || true
          echo "def localFlutterGradle = file('../packages/flutter_tools/gradle/flutter.gradle')" >> android/app/build.gradle
          echo "if (localFlutterGradle.exists()) {" >> android/app/build.gradle
          echo "  apply from: localFlutterGradle" >> android/app/build.gradle
          echo "} else {" >> android/app/build.gradle
          echo "  apply from: System.getenv('FLUTTER_ROOT') + '/packages/flutter_tools/gradle/flutter.gradle'" >> android/app/build.gradle
          echo "}" >> android/app/build.gradle
          echo "âœ… Gradle patch done."

      # 5ï¸âƒ£ Install Dependencies
      - name: ğŸ€ Install Dependencies
        run: |
          flutter clean
          flutter pub get
          flutter doctor -v
          echo "âœ… Dependencies installed."

      # 6ï¸âƒ£ Create Android Resources
      - name: ğŸ¨ Create Android Resources
        run: |
          mkdir -p android/app/src/main/res/mipmap-anydpi-v26
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/values-night
          echo '<?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
            <background android:drawable="@color/ic_launcher_background"/>
            <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
          </adaptive-icon>' > android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml

          echo '<?xml version="1.0" encoding="utf-8"?>
          <resources>
            <color name="ic_launcher_background">#1976D2</color>
            <color name="white">#FFFFFF</color>
            <color name="black">#000000</color>
          </resources>' > android/app/src/main/res/values/colors.xml

          echo '<?xml version="1.0" encoding="utf-8"?>
          <resources>
            <style name="LaunchTheme" parent="android:Theme.Material.Light.NoActionBar">
              <item name="android:windowBackground">@color/white</item>
            </style>
          </resources>' > android/app/src/main/res/values/styles.xml
          echo "âœ… Android resources created."

      # 7ï¸âƒ£ Firebase Config
      - name: ğŸ”¥ Firebase Config
        run: |
          echo "ğŸ”¥ Generating Firebase config..."
          echo "{
            \"project_info\": {
              \"project_number\": \"${FIREBASE_PROJECT_NUMBER}\",
              \"project_id\": \"${FIREBASE_PROJECT_ID}\",
              \"storage_bucket\": \"${FIREBASE_STORAGE_BUCKET}\"
            },
            \"client\": [{
              \"mobilesdk_app_id\": \"${FIREBASE_APP_ID}\",
              \"client_info\": {\"package_name\": \"com.example.visora_ai_flutter\"},
              \"api_key\": [{\"current_key\": \"${FIREBASE_API_KEY}\"}]
            }],
            \"configuration_version\": \"1\"
          }" > android/app/google-services.json
          echo "âœ… Firebase config created."

      # 8ï¸âƒ£ Build APK (Self-Healing Cloud Fix)
      - name: ğŸ§© Build APK (Self-Healing Cloud Fix)
        run: |
          echo "ğŸ§© Starting clean self-healing build..."
          rm -rf .dart_tool pubspec.lock build
          flutter clean
          flutter pub cache repair
          flutter pub get
          flutter pub outdated || true
          flutter pub upgrade --major-versions || true
          echo "ğŸ§  Regenerating plugin registrant..."
          dart run build_runner build --delete-conflicting-outputs || true
          flutter doctor -v
          echo "ğŸš€ Building APK..."
          flutter build apk --release --no-tree-shake-icons --verbose
          echo "âœ… Build completed successfully!"

      # 9ï¸âƒ£ Upload Artifact
      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisoraAI-Cloud-Release
          path: build/app/outputs/flutter-apk/app-release.apk

      # ğŸ”Ÿ Cloud Backup (Optional)
      - name: â˜ï¸ Cloud Backup (Optional)
        if: ${{ env.RCLONE_CONF != '' }}
        run: |
          sudo apt-get install -y rclone
          echo "${RCLONE_CONF}" > ~/.config/rclone/rclone.conf
          rclone copy build/app/outputs/flutter-apk/app-release.apk "mydrive:VisoraAI-Cloud"
          echo "âœ… Cloud backup complete."

      # 11ï¸âƒ£ Publish to GitHub Releases
      - name: ğŸš€ Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/heads/main')
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          tag_name: v${{ github.run_number }}
          name: "Visora AI Cloud Build #${{ github.run_number }}"
          body: |
            âœ… Visora AI Cloud Build Successful!
            ğŸ§  Self-Healing Build System
            ğŸ”¥ Firebase Ready
            âš™ï¸ Gradle 8.x + Kotlin 1.9.25
            â˜ï¸ Full Cloud Compatibility
