// âš™ï¸ Visora AI Cloud â€” Final Stable Flutter Gradle Configuration

pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
        // âœ… Add Flutter repository manually for GitHub runner
        maven { url "https://storage.googleapis.com/download.flutter.io" }
    }
}

plugins {
    // âœ… Let Flutter handle its Gradle plugin dynamically
    id "dev.flutter.flutter-gradle-plugin" apply false
}

// ğŸ§  Auto-detect Flutter SDK path for local & cloud
def flutterSdkPath = System.getenv("FLUTTER_HOME") ?: "../../.."
if (flutterSdkPath && new File(flutterSdkPath).exists()) {
    println("âœ… Flutter SDK detected at: $flutterSdkPath")
    includeBuild(flutterSdkPath)
} else {
    println("âš ï¸ Flutter SDK not found â€” using pre-installed GitHub runner SDK")
}

// âœ… Dependency management (for Android builds)
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
        maven { url "https://storage.googleapis.com/download.flutter.io" }
    }
}

rootProject.name = "visora_ai_flutter"
include(":app")

// âœ… Auto-include all Flutter plugins dynamically
def flutterPluginsFile = new File(rootDir, "../.flutter-plugins-dependencies")
if (flutterPluginsFile.exists()) {
    println("âœ… Flutter plugin dependency file found: ${flutterPluginsFile}")
    try {
        def json = new groovy.json.JsonSlurper().parseText(flutterPluginsFile.text)
        json.plugins.each { plugin ->
            def name = plugin.name
            def path = plugin.path
            if (path && new File(path).exists()) {
                include(":$name")
                project(":$name").projectDir = new File(path)
                println("ğŸ”— Linked plugin: $name")
            } else {
                println("âš ï¸ Missing plugin path for: $name â€” will regenerate.")
            }
        }
    } catch (Exception e) {
        println("âš ï¸ Failed to parse plugin file: ${e.message}")
    }
} else {
    println("âš ï¸ .flutter-plugins-dependencies not found â€” will regenerate automatically.")
}
