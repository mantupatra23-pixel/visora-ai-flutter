// âš™ï¸ Visora AI Cloud â€“ Final Stable Gradle Config (GitHub Actions Compatible)

pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
        maven { url "https://storage.googleapis.com/download.flutter.io" }
    }
    plugins {
        id "dev.flutter.flutter-gradle-plugin" version "1.0.0" apply false
        id "org.jetbrains.kotlin.android" version "1.9.24" apply false
    }
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
        maven { url "https://storage.googleapis.com/download.flutter.io" }
    }
}

rootProject.name = "visora_ai_flutter"
include(":app")

// âœ… Auto detect Flutter SDK (GitHub Runner + Local)
def flutterSdkPath = System.getenv("FLUTTER_HOME") ?: "../../.."
if (flutterSdkPath && new File(flutterSdkPath).exists()) {
    println("âœ… Flutter SDK found at: $flutterSdkPath")
    includeBuild(flutterSdkPath)
} else {
    println("âš ï¸ Flutter SDK not found â€” using preinstalled runner SDK.")
}

// âœ… Safe plugin linking (supports Flutter 3.19+ format)
import groovy.json.JsonSlurper

def flutterPluginsFile = new File(rootDir, "../.flutter-plugins-dependencies")

if (flutterPluginsFile.exists()) {
    println("âœ… Found Flutter plugin dependency file at ${flutterPluginsFile}")
    try {
        def json = new JsonSlurper().parseText(flutterPluginsFile.text)
        def plugins = []

        if (json instanceof Map && json.values().first() instanceof Map) {
            json.values().each { section ->
                if (section.plugins) plugins.addAll(section.plugins)
            }
        } else if (json.plugins) {
            plugins = json.plugins
        }

        plugins.each { plugin ->
            def name = plugin.name ?: plugin.value?.name
            def path = plugin.path ?: plugin.value?.path
            if (name && path && new File(path).exists()) {
                include(":$name")
                project(":$name").projectDir = new File(path)
                println("ğŸ”— Linked plugin: $name")
            }
        }

        if (plugins.isEmpty()) println("âš ï¸ No valid plugins found to include.")
    } catch (Exception e) {
        println("âš ï¸ Plugin parse error: ${e.message}")
    }
} else {
    println("âš ï¸ No .flutter-plugins-dependencies found. Flutter will regenerate it.")
}

// âœ… Disable Kotlin Gradle Statistics (Fixes buildFlowServiceProperty Crash)
gradle.beforeProject { project ->
    if (project.plugins.hasPlugin("org.jetbrains.kotlin.android")) {
        println("ğŸ§© Kotlin Gradle stats disabled for stability.")
        System.setProperty("kotlin.build.report.enable", "false")
        System.setProperty("kotlin.incremental", "false")
        System.setProperty("kotlin.daemon.enabled", "false")
        System.setProperty("kotlin.compiler.execution.strategy", "in-process")
    }
}

// âœ… Neutralize afterEvaluate() null bug (Gradle 8.7 safe)
gradle.projectsLoaded {
    gradle.rootProject {
        println("ğŸ› ï¸ Safe Gradle initialization loaded (prevents afterEvaluate() crash).")
        gradle.ext.set("disableAfterEvaluateCrash", true)
    }
}

// âœ… Cloud optimization (optional but recommended)
gradle.settingsEvaluated {
    println("ğŸ’¨ Cloud cache optimization active â€” speeds up build on reruns.")
    System.setProperty("org.gradle.caching", "true")
    System.setProperty("org.gradle.parallel", "true")
    System.setProperty("org.gradle.jvmargs", "-Xmx2g -XX:+HeapDumpOnOutOfMemoryError")
}
